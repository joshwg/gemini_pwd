<!-- templates/tags.html -->
{{define "title"}}Tags{{end}}

{{define "content"}}
<nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <div class="flex-shrink-0">
                <span class="text-xl font-bold">Password Manager - Tags</span>
            </div>
            <div class="flex items-center">
                <a href="/dashboard" class="text-gray-500 hover:text-gray-700 mr-4">Dashboard</a>
                <a href="/users" class="text-gray-500 hover:text-gray-700 mr-4">Users</a>
                <a href="/logout" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Logout</a>
            </div>
        </div>
    </div>
</nav>

<main class="p-8">
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-3xl font-bold">Your Tags</h1>
            <button id="createTagBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                <i class="fas fa-plus mr-2"></i>New Tag
            </button>
        </div>
        <table class="min-w-full bg-white rounded-lg overflow-hidden">
            <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                <tr>
                    <th class="py-3 px-6 text-left">Name</th>
                    <th class="py-3 px-6 text-left">Description</th>
                    <th class="py-3 px-6 text-left">Color</th>
                    <th class="py-3 px-6 text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="tagTableBody" class="text-gray-600 text-sm font-light">
                <!-- Tag data will be populated here by JavaScript -->
            </tbody>
        </table>
    </div>
</main>

<!-- Tag Modal (Create/Edit) -->
<div id="tagModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="tagModalTitle"></h3>
            <div class="mt-2 px-7 py-3">
                <form id="tagForm">
                    <input type="hidden" id="tagID" name="id">
                    <div class="mb-4">
                        <label for="tagName" class="block text-gray-700 text-sm font-bold mb-2">Tag Name</label>
                        <input type="text" id="tagName" name="name" maxlength="40" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-4">
                        <label for="tagDescription" class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                        <textarea id="tagDescription" name="description" maxlength="255" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="tagColor" class="block text-gray-700 text-sm font-bold mb-2">Color</label>
                        <input type="color" id="tagColor" name="color" class="w-full h-10 border rounded focus:outline-none focus:shadow-outline">
                    </div>
                    <!-- Color Palette -->
                    <div class="flex flex-wrap gap-2 justify-center mt-4 p-2 bg-gray-100 rounded-md" id="colorPalette">
                        <!-- 24 pre-defined colors -->
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-red-500" data-color="#ef4444"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-orange-500" data-color="#f97316"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-amber-500" data-color="#f59e0b"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-yellow-500" data-color="#eab308"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-lime-500" data-color="#84cc16"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-green-500" data-color="#22c55e"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-emerald-500" data-color="#10b981"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-teal-500" data-color="#14b8a6"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-cyan-500" data-color="#06b6d4"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-sky-500" data-color="#0ea5e9"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-blue-500" data-color="#3b82f6"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-indigo-500" data-color="#6366f1"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-violet-500" data-color="#8b5cf6"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-purple-500" data-color="#a855f7"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-fuchsia-500" data-color="#d946ef"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-pink-500" data-color="#ec4899"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-rose-500" data-color="#f43f5e"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-red-700" data-color="#b91c1c"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-gray-500" data-color="#6b7280"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-stone-500" data-color="#78716c"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-zinc-500" data-color="#71717a"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-slate-500" data-color="#64748b"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-neutral-500" data-color="#737373"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500 bg-gray-800" data-color="#1f2937"></div>
                    </div>
                    <div class="mt-4">
                        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Save</button>
                        <button type="button" class="close-modal bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const API_ORIGIN = window.location.origin;

    document.addEventListener('DOMContentLoaded', () => {
        const tagTableBody = document.getElementById('tagTableBody');
        const createTagBtn = document.getElementById('createTagBtn');
        const tagModal = document.getElementById('tagModal');
        const tagForm = document.getElementById('tagForm');
        const tagModalTitle = document.getElementById('tagModalTitle');
        const tagID = document.getElementById('tagID');
        const tagName = document.getElementById('tagName');
        const tagDescription = document.getElementById('tagDescription');
        const tagColor = document.getElementById('tagColor');
        const colorPalette = document.getElementById('colorPalette');

        fetchTags();

        createTagBtn.addEventListener('click', () => {
            tagModalTitle.textContent = 'Create New Tag';
            tagForm.reset();
            tagID.value = '';
            tagModal.classList.remove('hidden');
        });

        tagForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: tagName.value,
                description: tagDescription.value,
                color: tagColor.value
            };

            const method = tagID.value ? 'PUT' : 'POST';
            const url = tagID.value ? `${API_ORIGIN}/api/tags?id=${tagID.value}` : `${API_ORIGIN}/api/tags`;

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                console.log('Tag saved successfully!');
                tagModal.classList.add('hidden');
                fetchTags();
            } else {
                console.error('Failed to save tag.');
                const errorText = await response.text();
                alert('Error: ' + errorText);
            }
        });

        tagTableBody.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-tag-btn')) {
                const id = e.target.closest('.delete-tag-btn').dataset.id;
                if (confirm('Are you sure you want to delete this tag?')) {
                    const response = await fetch(`${API_ORIGIN}/api/tags?id=${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        fetchTags();
                    } else {
                        alert('Failed to delete tag.');
                    }
                }
            } else if (e.target.closest('.edit-tag-btn')) {
                const id = e.target.closest('.edit-tag-btn').dataset.id;
                fetchTagByID(id);
            }
        });
        
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.fixed').classList.add('hidden');
            });
        });

        colorPalette.addEventListener('click', (e) => {
            if (e.target.dataset.color) {
                tagColor.value = e.target.dataset.color;
            }
        });

        async function fetchTags() {
            try {
                const response = await fetch(`${API_ORIGIN}/api/tags`);
                if (!response.ok) {
                    if (response.redirected) {
                        window.location.reload();
                        return;
                    }
                    throw new Error('Failed to fetch tags.');
                }
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const tags = await response.json();
                    renderTags(tags);
                } else {
                    window.location.reload();
                }
            } catch (e) {
                console.error(e);
                alert(e.message);
            }
        }

        async function fetchTagByID(id) {
            try {
                const response = await fetch(`${API_ORIGIN}/api/tags?id=${id}`);
                if (!response.ok) {
                    if (response.redirected) {
                        window.location.reload();
                        return;
                    }
                    throw new Error('Failed to fetch tag.');
                }
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const tag = await response.json();
                    tagModalTitle.textContent = 'Edit Tag';
                    tagID.value = tag.id;
                    tagName.value = tag.name;
                    tagDescription.value = tag.description;
                    tagColor.value = tag.color;
                    tagModal.classList.remove('hidden');
                } else {
                    window.location.reload();
                }
            } catch (e) {
                console.error(e);
                alert(e.message);
            }
        }

        function renderTags(tags) {
            tagTableBody.innerHTML = '';
            tags.forEach(tag => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${tag.name}</td>
                    <td class="py-3 px-6 text-left">${tag.description}</td>
                    <td class="py-3 px-6 text-left">
                        <span class="inline-block w-6 h-6 rounded-full" style="background-color: ${tag.color};"></span>
                    </td>
                    <td class="py-3 px-6 text-center">
                        <div class="flex item-center justify-center">
                            <button class="edit-tag-btn w-4 mr-2 transform hover:text-blue-500 hover:scale-110" data-id="${tag.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-tag-btn w-4 mr-2 transform hover:text-red-500 hover:scale-110" data-id="${tag.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                tagTableBody.appendChild(row);
            });
        }
    });
</script>
{{end}}
