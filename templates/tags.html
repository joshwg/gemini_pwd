<!-- templates/tags.html -->
{{define "title"}}Tags{{end}}

{{define "content"}}
<main class="p-8">
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-3xl font-bold">Your Tags</h1>
            <button id="createTagBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                <i class="fas fa-plus mr-2"></i>New Tag
            </button>
        </div>
        <table class="min-w-full bg-white rounded-lg overflow-hidden">
            <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                <tr>
                    <th class="py-3 px-6 text-left">Name</th>
                    <th class="py-3 px-6 text-left">Description</th>
                    <th class="py-3 px-6 text-left">Color</th>
                    <th class="py-3 px-6 text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="tagTableBody" class="text-gray-600 text-sm font-light">
                <!-- Tag data will be populated here by JavaScript -->
            </tbody>
        </table>
    </div>
</main>

<!-- Tag Modal (Create/Edit) -->
<div id="tagModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="tagModalTitle"></h3>
            <div class="mt-2 px-7 py-3">
                <form id="tagForm">
                    <input type="hidden" id="tagID" name="id">
                    <div class="mb-4">
                        <label for="tagName" class="block text-gray-700 text-sm font-bold mb-2">Tag Name</label>
                        <input type="text" id="tagName" name="name" maxlength="40" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <div id="tagNameValidation" class="text-sm mt-1 hidden"></div>
                    </div>
                    <div class="mb-4">
                        <label for="tagDescription" class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                        <textarea id="tagDescription" name="description" maxlength="255" rows="4" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline resize-y"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="tagColor" class="block text-gray-700 text-sm font-bold mb-2">Color</label>
                        <input type="color" id="tagColor" name="color" class="w-full h-10 border rounded focus:outline-none focus:shadow-outline">
                    </div>
                    <!-- Color Palette -->
                    <div class="grid grid-cols-6 gap-2 justify-center mt-4 p-2 bg-gray-100 rounded-md" id="colorPalette">
                        <!-- 24 pre-defined colors -->
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #ef4444" data-color="#ef4444"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #f97316" data-color="#f97316"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #eab308" data-color="#eab308"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #84cc16" data-color="#84cc16"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #22c55e" data-color="#22c55e"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #14b8a6" data-color="#14b8a6"></div>
                        
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #06b6d4" data-color="#06b6d4"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #0ea5e9" data-color="#0ea5e9"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #3b82f6" data-color="#3b82f6"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #6366f1" data-color="#6366f1"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #8b5cf6" data-color="#8b5cf6"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #a855f7" data-color="#a855f7"></div>

                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #d946ef" data-color="#d946ef"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #ec4899" data-color="#ec4899"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #f43f5e" data-color="#f43f5e"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #b91c1c" data-color="#b91c1c"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #c2410c" data-color="#c2410c"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #a16207" data-color="#a16207"></div>

                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #6b7280" data-color="#6b7280"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #78716c" data-color="#78716c"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #71717a" data-color="#71717a"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #64748b" data-color="#64748b"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #737373" data-color="#737373"></div>
                        <div class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer hover:border-gray-500" style="background-color: #525252" data-color="#525252"></div>
                    </div>
                    <div class="mt-4">
                        <button type="submit" id="tagSubmitBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Save</button>
                        <button type="button" class="close-modal bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const API_ORIGIN = window.location.origin;
    const DEFAULT_TAG_COLOR = '#6B7280'; // dark gray - matches backend defaultTagColor
    
    // Utility function to get tag color with fallback to default
    function getTagColor(color) {
        return color && color.trim() !== '' ? color : DEFAULT_TAG_COLOR;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const tagTableBody = document.getElementById('tagTableBody');
        const createTagBtn = document.getElementById('createTagBtn');
        const tagModal = document.getElementById('tagModal');
        const tagForm = document.getElementById('tagForm');
        const tagModalTitle = document.getElementById('tagModalTitle');
        const tagID = document.getElementById('tagID');
        const tagName = document.getElementById('tagName');
        const tagDescription = document.getElementById('tagDescription');
        const tagColor = document.getElementById('tagColor');
        const colorPalette = document.getElementById('colorPalette');
        const tagSubmitBtn = document.getElementById('tagSubmitBtn');
        const tagNameValidation = document.getElementById('tagNameValidation');

        let allTags = []; // Store all tags for validation
        let currentEditingTagId = null; // Track which tag we're editing

        fetchTags();

        // Real-time validation for tag name
        tagName.addEventListener('input', validateTagName);
        tagName.addEventListener('blur', validateTagName);

        function validateTagName() {
            const name = tagName.value.trim();
            const isEditing = tagID.value !== '';
            let isValid = true;
            let message = '';

            // Reset styles
            tagName.classList.remove('border-red-500', 'border-green-500');
            tagNameValidation.classList.add('hidden');

            if (name === '') {
                isValid = false;
                message = 'Tag name is required';
                tagName.classList.add('border-red-500');
                tagNameValidation.classList.remove('hidden');
                tagNameValidation.classList.remove('text-green-600');
                tagNameValidation.classList.add('text-red-600');
                tagNameValidation.textContent = message;
            } else {
                // Check for duplicates
                const isDuplicate = allTags.some(tag => {
                    const isSameName = tag.name.toLowerCase() === name.toLowerCase();
                    const isDifferentTag = isEditing ? tag.id.toString() !== tagID.value : true;
                    return isSameName && isDifferentTag;
                });

                if (isDuplicate) {
                    isValid = false;
                    message = 'A tag with this name already exists';
                    tagName.classList.add('border-red-500');
                    tagNameValidation.classList.remove('hidden');
                    tagNameValidation.classList.remove('text-green-600');
                    tagNameValidation.classList.add('text-red-600');
                    tagNameValidation.textContent = message;
                } else if (name.length > 0) {
                    // Valid name
                    tagName.classList.add('border-green-500');
                    tagNameValidation.classList.remove('hidden');
                    tagNameValidation.classList.remove('text-red-600');
                    tagNameValidation.classList.add('text-green-600');
                    tagNameValidation.textContent = 'âœ“ Valid tag name';
                }
            }

            // Enable/disable submit button
            tagSubmitBtn.disabled = !isValid;
            if (isValid) {
                tagSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                tagSubmitBtn.classList.add('hover:bg-blue-700');
            } else {
                tagSubmitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                tagSubmitBtn.classList.remove('hover:bg-blue-700');
            }
        }

        createTagBtn.addEventListener('click', () => {
            tagModalTitle.textContent = 'Create New Tag';
            tagForm.reset();
            tagID.value = '';
            tagModal.classList.remove('hidden');
            // Reset validation state
            tagName.classList.remove('border-red-500', 'border-green-500');
            tagNameValidation.classList.add('hidden');
            tagSubmitBtn.disabled = true;
            tagSubmitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            tagSubmitBtn.classList.remove('hover:bg-blue-700');
        });

        tagForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Don't submit if validation fails
            if (tagSubmitBtn.disabled) {
                return;
            }
            
            const data = {
                name: tagName.value.trim(),
                description: tagDescription.value,
                color: tagColor.value
            };

            const method = tagID.value ? 'PUT' : 'POST';
            const url = tagID.value ? `${API_ORIGIN}/api/tags?id=${tagID.value}` : `${API_ORIGIN}/api/tags`;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    console.log('Tag saved successfully!');
                    tagModal.classList.add('hidden');
                    await fetchTags(); // Refresh tags list for validation
                } else {
                    console.error('Failed to save tag.');
                    const errorText = await response.text();
                    alert('Error: ' + errorText);
                }
            } catch (error) {
                console.error('Error saving tag:', error);
                alert('An error occurred while saving the tag.');
            }
        });

        tagTableBody.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-tag-btn')) {
                const id = e.target.closest('.delete-tag-btn').dataset.id;
                if (confirm('Are you sure you want to delete this tag?')) {
                    const response = await fetch(`${API_ORIGIN}/api/tags?id=${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        fetchTags();
                    } else {
                        alert('Failed to delete tag.');
                    }
                }
            } else if (e.target.closest('.edit-tag-btn')) {
                const id = e.target.closest('.edit-tag-btn').dataset.id;
                fetchTagByID(id);
            }
        });
        
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.fixed');
                modal.classList.add('hidden');
                // Reset validation state when closing modal
                tagName.classList.remove('border-red-500', 'border-green-500');
                tagNameValidation.classList.add('hidden');
                tagSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                tagSubmitBtn.classList.add('hover:bg-blue-700');
                tagSubmitBtn.disabled = false;
            });
        });

        // Close modal when clicking outside
        tagModal.addEventListener('click', (e) => {
            if (e.target === tagModal) {
                tagModal.classList.add('hidden');
                // Reset validation state when closing modal
                tagName.classList.remove('border-red-500', 'border-green-500');
                tagNameValidation.classList.add('hidden');
                tagSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                tagSubmitBtn.classList.add('hover:bg-blue-700');
                tagSubmitBtn.disabled = false;
            }
        });

        colorPalette.addEventListener('click', (e) => {
            if (e.target.dataset.color) {
                tagColor.value = e.target.dataset.color;
            }
        });

        async function fetchTags() {
            try {
                const response = await fetch(`${API_ORIGIN}/api/tags`);
                if (!response.ok) throw new Error('Failed to fetch tags.');
                const tags = await response.json();
                allTags = tags; // Store tags for validation
                renderTags(tags);
            } catch (e) {
                console.error(e);
                alert(e.message);
            }
        }

        async function fetchTagByID(id) {
            try {
                const response = await fetch(`${API_ORIGIN}/api/tags?id=${id}`);
                if (!response.ok) throw new Error('Failed to fetch tag.');
                const tag = await response.json();
                tagModalTitle.textContent = 'Edit Tag';
                tagID.value = tag.id;
                tagName.value = tag.name;
                tagDescription.value = tag.description;
                tagColor.value = getTagColor(tag.color);
                tagModal.classList.remove('hidden');
                // Trigger validation for the current name
                validateTagName();
            } catch (e) {
                console.error(e);
                alert(e.message);
            }
        }

        function renderTags(tags) {
            tagTableBody.innerHTML = '';
            
            // Handle empty state
            if (tags.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = 
                    '<td colspan="4" class="py-8 px-6 text-center text-gray-500">' +
                        '<div class="flex flex-col items-center">' +
                            '<i class="fas fa-tags text-3xl text-gray-300 mb-2"></i>' +
                            '<p class="text-lg font-medium">No tags found</p>' +
                            '<p class="text-sm">Create your first tag to organize your passwords</p>' +
                        '</div>' +
                    '</td>';
                tagTableBody.appendChild(emptyRow);
                return;
            }
            
            tags.forEach(tag => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left break-all">${tag.name}</td>
                    <td class="py-3 px-6 text-left break-all">${tag.description}</td>
                    <td class="py-3 px-6 text-left">
                        <span class="inline-block w-6 h-6 rounded-full" style="background-color: ${getTagColor(tag.color)};"></span>
                    </td>
                    <td class="py-3 px-6 text-center">
                        <div class="flex item-center justify-center">
                            <button class="edit-tag-btn w-4 mr-2 transform hover:text-blue-500 hover:scale-110" data-id="${tag.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-tag-btn w-4 mr-2 transform hover:text-red-500 hover:scale-110" data-id="${tag.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                tagTableBody.appendChild(row);
            });
        }
    });
</script>
{{end}}
